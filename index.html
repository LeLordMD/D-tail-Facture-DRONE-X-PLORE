<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GÃ©nÃ©rateur â€“ DÃ©tail de lâ€™intervention</title>
  <link rel="manifest" href="manifest.json" />

  <style>
    html, body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      background: #f6f6f6;
    }

    .app-container {
      max-width: 600px;
      margin: 0 auto;
      padding: 16px;
      background: #ffffff;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      color: #333;
    }

    h1 {
      font-size: 1.5rem;
      margin-bottom: 12px;
      text-align: center;
    }

    label {
      display: block;
      font-weight: bold;
      margin-top: 12px;
      font-size: 0.95rem;
    }

    input, select, button {
      width: 100%;
      box-sizing: border-box;
      font-size: 1rem;
      margin-top: 4px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    button {
      background: #001f3f;
      color: #fff;
      border: none;
      cursor: pointer;
    }

    .with-unit {
      position: relative;
    }

    .with-unit input {
      padding-right: 40px;
    }

    .with-unit .unit {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #555;
      pointer-events: none;
      font-size: 0.9rem;
    }

    .product-item {
      margin-bottom: 12px;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: #fafafa;
    }

    #addProductBtn,
    #removeProductBtn {
      width: 48px;
      height: 48px;
      font-size: 1.25rem;
      padding: 0;
      margin-left: 8px;
      color: #fff;
    }

    #addProductBtn { background: #28a745; }
    #removeProductBtn { background: #dc3545; }

    .invoice {
      display: none;
      position: relative;
      width: 190mm;
      min-height: 277mm;
      padding: 10mm;
      background: #fff;
      box-sizing: border-box;
      font-size: 12pt;
      line-height: 1.4;
    }

    .invoice-title {
      text-transform: uppercase;
      font-weight: bold;
      border-bottom: 1px solid #ccc;
      padding-bottom: 4px;
      margin-bottom: 12px;
      font-size: 14pt;
    }

    .invoice-facture {
      margin-bottom: 12px;
      font-size: 12pt;
    }

    .client-box {
      border: 1px solid #ccc;
      padding: 8px;
      margin-bottom: 12px;
      border-radius: 4px;
      width: fit-content;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      word-break: break-word;
    }

    th, td {
      padding: 6px 8px;
      border: 1px solid #000;
      text-align: left;
      vertical-align: top;
    }

    th {
      background: #f0f0f0;
    }

    .closing {
      margin-top: 20px;
      font-size: 12pt;
    }

    .footer {
      position: absolute;
      bottom: 10mm;
      left: 10mm;
      right: 10mm;
      display: flex;
      justify-content: space-between;
      font-size: 10pt;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <h1>ðŸ“„ GÃ©nÃ©rateur â€“ DÃ©tail de lâ€™intervention</h1>

    <label for="facturationNumber">NÂ° de facturation :</label>
    <input type="text" id="facturationNumber" value="FAC-" />

    <div id="clientInfo" class="section">
      <label>Info client associÃ©e :</label>
      <div class="client-box">
        <p><strong>Nom :</strong> <span id="clientNom">â€”</span></p>
        <p><strong>PrÃ©nom :</strong> <span id="clientPrenom">â€”</span></p>
        <p><strong>Lieu :</strong> <span id="clientLieu">â€”</span></p>
      </div>
    </div>

    <div class="section">
      <label>Produits et quantitÃ©s :</label>
      <div id="productContainer">
        <div class="product-item">
          <label for="prodName-1">Produit nÂ°1 :</label>
          <input type="text" id="prodName-1" class="prodName" placeholder="Nom du produit" />

          <label for="prodQty-1">QuantitÃ© nÂ°1 :</label>
          <div class="with-unit">
            <input type="text" id="prodQty-1" class="prodQty" placeholder="QuantitÃ©" />
            <span class="unit">L</span>
          </div>
        </div>
      </div>
      <div style="display:flex; margin-top:8px;">
        <button type="button" id="addProductBtn">+</button>
        <button type="button" id="removeProductBtn">â€“</button>
      </div>
    </div>

    <div class="section">
      <label for="epandageProduit">Produit Ã  Ã©pandre :</label>
      <input type="text" id="epandageProduit" placeholder="Nom du produit" />

      <label for="epandageConcentration">Concentration :</label>
      <div class="with-unit">
        <input type="text" id="epandageConcentration" placeholder="Ex : 100" />
        <span class="unit">Kg/ha</span>
      </div>
    </div>

    <div class="section">
      <label>TempÃ©rature extÃ©rieure :</label>
      <div class="with-unit">
        <input type="text" id="tempExterieure" placeholder="Ex : 25" />
        <span class="unit">Â°C</span>
      </div>

      <label>Temps :</label>
      <select id="temps">
        <option value="EnsoleillÃ©">EnsoleillÃ©</option>
        <option value="Couvert">Couvert</option>
        <option value="Nuageux">Nuageux</option>
        <option value="TrÃ¨s nuageux">TrÃ¨s nuageux</option>
      </select>

      <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:12px;">
        <div style="flex:1; min-width:120px;">
          <label>Vent :</label>
          <select id="vent">
            <option value="NÃ©ant">NÃ©ant</option>
            <option value="Faible">Faible</option>
            <option value="ModÃ©rÃ©">ModÃ©rÃ©</option>
            <option value="Fort">Fort</option>
          </select>
        </div>
        <div style="flex:1; min-width:120px;">
          <label>Direction :</label>
          <select id="direction">
            <option value="NÃ©ant">NÃ©ant</option>
            <option value="N">N</option>
            <option value="NO">NO</option>
            <option value="O">O</option>
            <option value="SO">SO</option>
            <option value="S">S</option>
            <option value="SE">SE</option>
            <option value="E">E</option>
            <option value="NE">NE</option>
          </select>
        </div>
      </div>
    </div>

    <button id="btnGenerate">GÃ©nÃ©rer le PDF</button>
  </div>

  <!-- TEMPLATE PDF (invisible Ã  lâ€™Ã©cran) -->
  <div id="rapportPDF" class="invoice">
    <div class="content">
      <div id="invoiceTitle" class="invoice-title"></div>
      <div class="invoice-facture">
        <strong>NÂ° de facturation associÃ© :</strong>
        <span id="pdfFactureNumber"></span>
      </div>
      <div class="client-box">
        <p><strong>Nom :</strong> <span id="pdfClientNom"></span></p>
        <p><strong>PrÃ©nom :</strong> <span id="pdfClientPrenom"></span></p>
        <p><strong>Lieu :</strong> <span id="pdfClientLieu"></span></p>
      </div>

      <table>
        <thead>
          <tr>
            <th>CatÃ©gorie</th>
            <th>Information</th>
            <th>UnitÃ©</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Produits utilisÃ©s</td>
            <td id="pdfProdUtilises"></td>
            <td></td>
          </tr>
          <tr>
            <td>QuantitÃ© de produits</td>
            <td id="pdfQuantiteProduits"></td>
            <td>L</td>
          </tr>
          <tr>
            <td>Ã‰pandage engrais</td>
            <td id="pdfEpandageProduct"></td>
            <td></td>
          </tr>
          <tr>
            <td>Concentration produit</td>
            <td id="pdfEpandageConcentration"></td>
            <td>Kg/ha</td>
          </tr>
          <tr style="background:#f0f0f0; font-weight:bold;">
            <td colspan="3">ParamÃ¨tres MÃ©tÃ©o</td>
          </tr>
          <tr>
            <td>TempÃ©rature extÃ©rieure</td>
            <td id="pdfTempExterieure"></td>
            <td>Â°C</td>
          </tr>
          <tr>
            <td>Temps</td>
            <td id="pdfTemps"></td>
            <td></td>
          </tr>
          <tr>
            <td>Vent</td>
            <td id="pdfVent"></td>
            <td>Km/h</td>
          </tr>
          <tr>
            <td>Direction</td>
            <td id="pdfDirection"></td>
            <td></td>
          </tr>
        </tbody>
      </table>

      <div class="closing">
        En vous remerciant de votre confiance.<br/>
        Cordialement.
      </div>
    </div>
    <div class="footer">
      <strong>SIRET : 894 329 564 00013</strong>
      <strong>DRONE X-PLORE</strong>
    </div>
  </div>

  <!-- Librairies -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <script>
    // Register service worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js');
    }

    // Firebase init
    const firebaseConfig = {
      apiKey: "AIzaSyCRO_KlygXQ3TkaAXfBDSxrxY5rA4bZCtc",
      authDomain: "drone-traitement-vigne.firebaseapp.com",
      databaseURL: "https://drone-traitement-vigne-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "drone-traitement-vigne",
      storageBucket: "drone-traitement-vigne.appspot.com",
      messagingSenderId: "494266480932",
      appId: "1:494266480932:web:84e794ccd1b61c23351bb1",
      measurementId: "G-EY62N6QG3X"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // PrÃ©chargement client
    document.getElementById('facturationNumber')
      .addEventListener('blur', async e => {
        const num = e.target.value.trim();
        if (!num.startsWith("FAC-")) return;
        const snap = await db.ref('Factures/' + num).once('value');
        if (snap.exists()) {
          const d = snap.val();
          document.getElementById('clientNom').textContent    = d.nom    || 'â€”';
          document.getElementById('clientPrenom').textContent = d.prenom || 'â€”';
          document.getElementById('clientLieu').textContent   = d.lieu   || 'â€”';
        }
      });

    // Gestion dynamique produits
    let productCount = 1;
    document.getElementById('addProductBtn').addEventListener('click', () => {
      productCount++;
      const container = document.getElementById('productContainer');
      const item = document.createElement('div');
      item.className = 'product-item';
      item.innerHTML = `
        <label for="prodName-${productCount}">Produit nÂ°${productCount} :</label>
        <input type="text" id="prodName-${productCount}" class="prodName" placeholder="Nom du produit" />

        <label for="prodQty-${productCount}">QuantitÃ© nÂ°${productCount} :</label>
        <div class="with-unit">
          <input type="text" id="prodQty-${productCount}" class="prodQty" placeholder="QuantitÃ©" />
          <span class="unit">L</span>
        </div>`;
      container.appendChild(item);
    });

    document.getElementById('removeProductBtn').addEventListener('click', () => {
      if (productCount > 1) {
        const container = document.getElementById('productContainer');
        container.removeChild(container.lastElementChild);
        productCount--;
      }
    });

    // GÃ©nÃ©ration PDF
    document.getElementById('btnGenerate').addEventListener('click', async () => {
      const num = document.getElementById('facturationNumber').value.trim() || 'â€”';
      document.getElementById('invoiceTitle').textContent     = `DÃ©tail-${num}`;
      document.getElementById('pdfFactureNumber').textContent = num;

      // Client
      const snap = await db.ref('Factures/' + num).once('value');
      if (snap.exists()) {
        const d = snap.val();
        document.getElementById('pdfClientNom').textContent    = d.nom    || 'â€”';
        document.getElementById('pdfClientPrenom').textContent = d.prenom || 'â€”';
        document.getElementById('pdfClientLieu').textContent   = d.lieu   || 'â€”';
      }

      // Produits & quantitÃ©s
      const prodNames = Array.from(document.querySelectorAll('.prodName'))
        .map(el => el.value.trim() || 'â€”');
      const prodQtys  = Array.from(document.querySelectorAll('.prodQty'))
        .map(el => el.value.trim() || 'â€”');

      document.getElementById('pdfProdUtilises').innerHTML = 
        prodNames.map((n,i) => `- P${i+1}: ${n}`).join('<br/>');
      document.getElementById('pdfQuantiteProduits').innerHTML = 
        prodQtys.map((q,i) => `- P${i+1}: ${q}`).join('<br/>');

      // Ã‰pandage
      const epProd = document.getElementById('epandageProduit').value.trim() || 'â€”';
      const epConc = document.getElementById('epandageConcentration').value.trim() || 'â€”';
      document.getElementById('pdfEpandageProduct').textContent       = epProd;
      document.getElementById('pdfEpandageConcentration').textContent = epConc;

      // MÃ©tÃ©o
      document.getElementById('pdfTempExterieure').textContent = 
        document.getElementById('tempExterieure').value.trim() || 'â€”';
      document.getElementById('pdfTemps').textContent     = 
        document.getElementById('temps').value;
      document.getElementById('pdfVent').textContent      = 
        document.getElementById('vent').value;
      document.getElementById('pdfDirection').textContent = 
        document.getElementById('direction').value;

      // Affiche template + scroll
      const tpl = document.getElementById('rapportPDF');
      tpl.style.display = 'block';
      window.scrollTo(0,0);

      // Options html2pdf
      const opt = {
        margin:      [10,10,10,10],
        filename:    `DÃ©tail-${num}.pdf`,
        jsPDF:       { unit:'mm', format:'a4', orientation:'portrait' },
        html2canvas: { scale:2, scrollY:0 }
      };

      await html2pdf().set(opt).from(tpl).save();
      tpl.style.display = 'none';
    });
  </script>
</body>
</html>